<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Habit Tracker</h1>
        
        <!-- ç¿’æ…£è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="add-habit-section">
            <input type="text" id="habitInput" placeholder="ç¿’æ…£åã‚’å…¥åŠ›">
            <input type="time" id="habitTimeInput">
            <button id="addButton" class="add-btn">è¿½åŠ </button>
        </div>
        
        <!-- ç¿’æ…£ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="habits-section">
            <h2 class="habits-title">
                <span class="file-icon">ğŸ“‹</span>
                ç¿’æ…£ãƒªã‚¹ãƒˆ
            </h2>
            
            <div id="habitsList"></div>
        </div>
        
        <!-- é”æˆç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="achievement-section">
            <p class="achievement-text">ä»Šæ—¥ã®é”æˆç‡ï¼š1/3</p>
        </div>

        <!-- é€šçŸ¥ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="reminder-section">
            <h2 class="reminder-title">é€šçŸ¥ã®è¨­å®š</h2>
            <div class="reminder-controls">
                <input type="time" id="timeInput">
                <input type="text" id="reminderLabel" placeholder="é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰">
                <button id="setTimeButton" class="add-btn">è¨­å®š</button>
            </div>
            <div id="remindersList" class="reminders-list"></div>
        </div>
    </div>
    <script>
        (function(){
            const habitInput = document.getElementById('habitInput');
            const habitTimeInput = document.getElementById('habitTimeInput');
            const addButton = document.getElementById('addButton');
            const habitsList = document.getElementById('habitsList');
            const achievementText = document.querySelector('.achievement-text');

            function updateAchievement(){
                const items = habitsList.querySelectorAll('.habit-item');
                const total = items.length;
                const done = habitsList.querySelectorAll('.habit-checkbox:checked').length;
                achievementText.textContent = `ä»Šæ—¥ã®é”æˆç‡ï¼š${done}/${total}`;
            }

            function createHabitElement(title, time){
                const id = 'habit-' + Date.now() + Math.random().toString(36).slice(2,7);
                const wrap = document.createElement('div');
                wrap.className = 'habit-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = id;
                checkbox.className = 'habit-checkbox';
                checkbox.addEventListener('change', updateAchievement);

                const label = document.createElement('label');
                label.htmlFor = id;
                label.className = 'habit-label';
                label.textContent = title;

                if(time){
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'habit-time';
                    timeSpan.textContent = time;
                    label.appendChild(timeSpan);
                }

                wrap.appendChild(checkbox);
                wrap.appendChild(label);
                return wrap;
            }

            function addHabit(){
                const title = habitInput.value.trim();
                if(!title) return;
                const time = habitTimeInput.value || '';
                const el = createHabitElement(title, time);
                habitsList.appendChild(el);
                habitInput.value = '';
                habitTimeInput.value = '';
                habitInput.focus();
                updateAchievement();

                if(time){
                    // è¿½åŠ æ™‚ã«é€šçŸ¥æ¨©é™ã‚’è¦æ±‚ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ã‚ˆã‚‹è¦æ±‚ï¼‰
                    ensureNotificationPermission();
                    addReminder(time, title);
                }
            }

            addButton.addEventListener('click', addHabit);
            habitInput.addEventListener('keydown', function(e){ if(e.key === 'Enter') addHabit(); });

            // åˆæœŸçŠ¶æ…‹ã®æ›´æ–°ï¼ˆåˆæœŸãƒªã‚¹ãƒˆã¯ç©ºï¼‰
            updateAchievement();

            // --- é€šçŸ¥ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼‰æ©Ÿèƒ½ ---
            const timeInput = document.getElementById('timeInput');
            const setTimeButton = document.getElementById('setTimeButton');
            const remindersList = document.getElementById('remindersList');
            const reminderLabel = document.getElementById('reminderLabel');

            let reminders = [];

            function saveReminders(){
                localStorage.setItem('reminders', JSON.stringify(reminders));
            }

            function loadReminders(){
                const raw = localStorage.getItem('reminders');
                if(raw) reminders = JSON.parse(raw);
                else reminders = [];
            }

            function renderReminders(){
                remindersList.innerHTML = '';
                reminders.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'reminder-item';
                    div.textContent = `${r.time} â€” ${r.label || 'é€šçŸ¥'} `;
                    const btn = document.createElement('button');
                    btn.className = 'remove-btn';
                    btn.textContent = 'å‰Šé™¤';
                    btn.addEventListener('click', ()=>{ removeReminder(r.id); });
                    div.appendChild(btn);
                    remindersList.appendChild(div);
                });
            }

            function addReminder(time, label){
                const id = 'rem-' + Date.now() + Math.random().toString(36).slice(2,7);
                reminders.push({ id, time, label: label || '', lastNotifiedDate: null });
                saveReminders();
                renderReminders();
            }

            function removeReminder(id){
                reminders = reminders.filter(r=>r.id !== id);
                saveReminders();
                renderReminders();
            }

            function ensureNotificationPermission(){
                if(!('Notification' in window)) return Promise.resolve(false);
                if(Notification.permission === 'granted') return Promise.resolve(true);
                if(Notification.permission === 'denied') return Promise.resolve(false);
                return Notification.requestPermission().then(p => p === 'granted');
            }

            function showNotification(title, body){
                if(!('Notification' in window)) return;
                if(Notification.permission !== 'granted') return;
                try{
                    new Notification(title, { body });
                }catch(e){
                    console.error('é€šçŸ¥ã‚¨ãƒ©ãƒ¼', e);
                }
            }

            function checkReminders(){
                const now = new Date();
                const hh = String(now.getHours()).padStart(2,'0');
                const mm = String(now.getMinutes()).padStart(2,'0');
                const today = now.toISOString().slice(0,10);
                const current = `${hh}:${mm}`;

                reminders.forEach(r => {
                    if(r.time === current && r.lastNotifiedDate !== today){
                        ensureNotificationPermission().then(ok => {
                            if(ok){
                                showNotification('ç¿’æ…£ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼', r.label || `æ™‚åˆ» ${r.time} ã§ã™`);
                                // é€šçŸ¥ã‚’å®Ÿéš›ã«å‡ºã—ãŸå ´åˆã®ã¿æœ€çµ‚é€šçŸ¥æ—¥ã‚’æ›´æ–°
                                r.lastNotifiedDate = today;
                                saveReminders();
                                renderReminders();
                            } else {
                                // é€šçŸ¥æœªè¨±å¯ã®å ´åˆã¯æ›´æ–°ã—ãªã„ï¼ˆå†è©¦è¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
                                console.log('é€šçŸ¥æœªè¨±å¯:', r.time, r.label);
                            }
                        }).catch(err => console.error('ensureNotificationPermission error', err));
                    }
                });
            }

            // åˆæœŸåŒ–
            loadReminders();
            renderReminders();

            setTimeButton.addEventListener('click', function(){
                const time = timeInput.value;
                if(!time) return;
                const label = reminderLabel.value.trim();
                // è¨­å®šãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«é€šçŸ¥æ¨©é™ã‚’æ˜ç¤ºçš„ã«è¦æ±‚
                ensureNotificationPermission();
                addReminder(time, label);
                timeInput.value = '';
                reminderLabel.value = '';
            });

            // å®šæœŸãƒã‚§ãƒƒã‚¯ï¼ˆ1åˆ†ã”ã¨ï¼‰ â€” æ™‚åˆ»ã¯åˆ†å˜ä½ã§æ¯”è¼ƒã—ã¦ã„ã‚‹ãŸã‚60ç§’ã”ã¨ã§ååˆ†
            checkReminders();
            setInterval(checkReminders, 60000);

        })();
    </script>
</body>
</html>
